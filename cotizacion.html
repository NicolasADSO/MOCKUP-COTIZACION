<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mock1 - Cotizaci√≥n Gadier</title>

  <!-- === ESTILOS PRINCIPALES === -->
  <link rel="stylesheet" href="./assets/css/layout.css" />
  <link rel="stylesheet" href="./assets/css/sidebar.css" />
  <link rel="stylesheet" href="./assets/css/cotizacion.css" />

  <!-- === Librer√≠as locales jsPDF === -->
  <script src="./assets/js/libs/jspdf.umd.min.js"></script>
  <script src="./assets/js/libs/jspdf.plugin.autotable.min.js"></script>

  <!-- ‚úÖ Librer√≠a PowerPoint -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
</head>

<body>

  <script>
    // Si NO hay sesi√≥n ‚Üí enviar al login
    if (!localStorage.getItem("usuario_logueado")) {
      window.location.href = "login.html";
    }
  </script>


  <!-- ========== SIDEBAR REAL (VAC√çO, LUEGO SE LLENA) ========== -->
  <div id="sidebar"></div>

  <!-- ========== CONTENIDO PRINCIPAL MOVER√ÅNDOSE ========== -->
  <main class="main-content">

    <!-- === HEADER === -->
    <header class="navbar-fija">
      <h1>üìÇ Generador de Cotizaci√≥n (Mockup Gadier)</h1>
    </header>

    <!-- === CONTENIDO === -->
    <div class="cotizacion-layout">

      <!-- ============================================================
           üß© COLUMNA IZQUIERDA: FORMULARIO DE DATOS
      ============================================================ -->
      <section class="columna-form">
        <h2>üß© Datos de Cotizaci√≥n</h2>

        <!-- Selecci√≥n de √Årea -->
        <div class="form-group">
          <label for="areaSelect">√Årea:</label>
          <select id="areaSelect">
            <option value="">Seleccione √°rea...</option>
            <option value="Archiv√≠stico">Archiv√≠stico</option>
            <option value="Bibliotecolog√≠a">Bibliotecolog√≠a</option>
          </select>
        </div>

        <!-- Selecci√≥n de Proceso -->
        <div class="form-group">
          <label for="procesoSelect">Proceso:</label>
          <select id="procesoSelect">
            <option value="">Seleccione proceso...</option>
          </select>
        </div>

        <!-- Subprocesos -->
        <div id="subprocesosContainer" class="form-group" style="display:none;">
          <label>Subprocesos:</label>
          <div id="subprocesosList" class="checkbox-list"></div>
        </div>

        <!-- Proceso personalizado -->
        <div id="otroProcesoContainer" class="form-group" style="display:none;">
          <label>Nuevo proceso personalizado:</label>
          <input type="text" id="nombreOtroProceso" placeholder="Nombre del nuevo proceso" />
          <div class="form-subproc-manual">
            <input type="text" id="nombreSubproceso" placeholder="Nombre del subproceso" />
            <input type="number" id="precioSubproceso" placeholder="Precio" min="0" />
          </div>
          <ul id="listaSubprocesosManuales" class="lista-subprocesos"></ul>
          <button id="btnAgregarProcesoManual" type="button" class="btn-agregar-proceso">
            Agregar proceso al resumen
          </button>
        </div>

        <!-- ============================================================
        üì¶ SUMINISTROS ‚Äî BLOQUE
        ============================================================ -->
        <div class="bloque-extra">
          <h3 class="titulo-extra">üì¶ Suministros</h3>

          <select id="selectSuministro" class="input-extra">
            <option value="">Seleccione suministro...</option>
          </select>

          <div class="fila-extra">
            <input id="cantidadSuministro" type="number" class="input-extra" placeholder="Cantidad de unidades" min="1">
            <input id="valorSuministro" type="text" class="input-extra" placeholder="Valor unitario ($)" readonly>
          </div>

          <button id="btnAgregarSuministro" class="btn-extra">
            ‚ûï Agregar suministro
          </button>
        </div>

        <!-- ============================================================
        ‚öôÔ∏è EQUIPOS ‚Äî BLOQUE
        ============================================================ -->
        <div class="bloque-extra">
          <h3 class="titulo-extra">‚öôÔ∏è Equipos</h3>

          <select id="selectEquipo" class="input-extra">
            <option value="">Seleccione equipo...</option>
          </select>

          <div class="fila-extra">
            <input id="cantidadEquipo" type="number" class="input-extra" placeholder="Cantidad de equipos" min="1">
            <input id="valorEquipo" type="text" class="input-extra" placeholder="Valor unitario ($)" readonly>
          </div>

          <button id="btnAgregarEquipo" class="btn-extra">
            ‚ûï Agregar equipo
          </button>
        </div>




        <!-- ============================================================
            üë• FUNCIONARIOS ‚Äî BLOQUE DENTRO DE COTIZACI√ìN (NUEVO ORDEN)
        ============================================================ -->
        <div class="bloque-funcionarios bloque-extra">
          <h3 class="titulo-extra">üë• Funcionarios</h3>

          <!-- 1Ô∏è‚É£ SELECT PRINCIPAL (ARRIBA) -->
          <select id="selectFuncionario" class="input-extra">
            <option value="">Seleccione funcionario...</option>
          </select>

          <!-- 2Ô∏è‚É£ PLANIFICACI√ìN AUTOM√ÅTICA -->
          <div class="fila-extra" style="margin-top:10px; margin-bottom:6px;">
            <input id="totalFuncionariosProyecto" type="number" class="input-extra"
              placeholder="Total funcionarios del proyecto" min="1" />

            <input id="diasHabilesProyecto" type="number" class="input-extra" placeholder="D√≠as h√°biles del funcionario"
              min="1" />
          </div>

          <button id="btnDistribuirFuncionarios" class="btn-extra" style="margin-bottom:14px;">
            ‚öôÔ∏è Calcular distribuci√≥n autom√°tica
          </button>

          <!-- üìä MINI-TABLA ‚Äî EDITABLE -->
          <div id="tablaDistribucionContainer" style="display:none;margin:10px 0;">
            <h4 style="margin-bottom:6px;color:#990f0c;font-size:15px;">
              üìä Distribuci√≥n estimada del personal
            </h4>

            <table id="tablaDistribucion" style="width:100%;border-collapse:collapse;font-size:13px;">
              <thead>
                <tr style="background:#990f0c;color:white;">
                  <th style="padding:6px;border:1px solid #bbb;">Funcionario</th>
                  <th style="padding:6px;border:1px solid #bbb;">D√≠as asignados</th>
                  <th style="padding:6px;border:1px solid #bbb;">Horas/d√≠a</th>
                  <!-- üÜï NUEVO CAMPO -->
                  <th style="padding:6px;border:1px solid #bbb;">Gastos extras</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>


          <!-- VALOR POR HORA (AUTOCARGADO) -->
          <input id="valorHoraFuncionario" type="text" class="input-extra" placeholder="Valor por hora ($)" readonly />

          <!-- BOT√ìN AGREGAR -->
          <button id="btnAgregarFuncionarioCot" class="btn-extra" disabled>
            ‚ûï Agregar funcionario
          </button>
        </div>

        <!-- ============================================================
        ü§ù ALIADOS ESTRAT√âGICOS ‚Äî BLOQUE
        ============================================================ -->
        <div class="bloque-extra">
          <h3 class="titulo-extra">ü§ù Aliados Estrat√©gicos</h3>

          <!-- Seleccionar aliado -->
          <select id="selectAliado" class="input-extra">
            <option value="">Seleccione aliado...</option>
          </select>

          <!-- Seleccionar servicio del aliado -->
          <select id="selectServicioAliado" class="input-extra" style="margin-top:8px;">
            <option value="">Seleccione servicio...</option>
          </select>

          <button id="btnAgregarAliado" class="btn-extra" style="margin-top:10px;">
            ‚ûï Agregar servicio del aliado
          </button>
        </div>


      </section>

      <!-- ============================================================
           üìä COLUMNA DERECHA: TABLA DE RESUMEN
      ============================================================ -->
      <section class="columna-resumen">
        <h2>üìä Resumen de Cotizaci√≥n</h2>

        <button id="btnColumnas" class="btn-terciario" style="margin-bottom:10px;">
          ‚öôÔ∏è Configurar columnas
        </button>


        <!-- ‚úÖ TABLA DE RESUMEN (sin switch de vista) -->
        <div class="tabla-scroll">
          <table id="tablaResumen">
            <thead>
              <tr>
                <th>Proceso</th>
                <th>Unidad</th>
                <th>Cantidad</th>
                <th>Valor Unitario</th>
                <th>Costo Estimado</th>
                <th>Tiempo</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>

            <tbody></tbody>
          </table>
        </div>

        <!-- Total general -->
        <div class="total-box">
          <strong>Total General:</strong>
          <span id="totalGeneral">$0</span>
        </div>

        <!-- Descuento -->
        <div class="form-group descuento-box">
          <label for="descuentoInput">Descuento (%)</label>
          <input type="number" id="descuentoInput" placeholder="Ej: 10" min="0" max="100"
            style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc;text-align:center;" />
        </div>

        <!-- Gastos Adicionales (DEBE IR AQU√ç, ANTES DEL IVA) -->
        <div class="form-group gastos-box">
          <label for="gastosInput">Gastos adicionales ($)</label>
          <input type="text" id="gastosInput" placeholder="Ej: 150000"
            style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc;text-align:center;" />
        </div>

        <div class="gastos-extra-opciones" style="margin-top:6px;">
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="ocultarGastos">
            Ocultar gastos adicionales al cliente
          </label>
        </div>




        <!-- ‚öôÔ∏è Checkbox IVA: ser√° insertado din√°micamente por JS -->

        <!-- === BOTONES PRINCIPALES === -->
        <button id="btnPDF" class="btn-secundario">üìÑ Generar PDF Corporativo</button>

        <button id="btnPropuestaValor" style="margin-top:10px;background:#7d0c0a;color:white;border:none;
                 padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;width:100%;">
          üé® Generar Propuesta de Valor (PPT)
        </button>

        <button id="btnVaciar" class="btn-terciario" disabled>üóëÔ∏è Vaciar Tabla</button>
      </section>
    </div>
  </main>
  <!-- ============================================================
     üü¶ MODAL UNIVERSAL ‚Äî DATOS DEL CLIENTE (PDF + PROPUESTA)
  =============================================================== -->
  <div id="modalDatosCliente" class="modal-cliente-overlay" style="display:none;">
    <div class="modal-cliente-contenedor" style="max-width:480px;">

      <h2 style="color:#990f0c;margin:0 0 15px 0;font-size:22px;font-weight:700;">
        üìã Datos del Cliente
      </h2>

      <!-- ‚≠ê CLIENTES FAVORITOS -->
      <div class="form-group">
        <label for="clienteExistenteSelect">Clientes guardados ‚≠ê</label>

        <select id="clienteExistenteSelect">
          <option value="">‚Äî Cliente nuevo ‚Äî</option>
        </select>

        <!-- BOT√ìN PARA MARCAR COMO FAVORITO -->
        <div style="margin-top:6px;">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" id="guardarFavorito">
            ‚≠ê Guardar este cliente como favorito
          </label>
        </div>
      </div>


      <!-- Nombre -->
      <div class="form-group">
        <label for="modalNombreCliente">Nombre del cliente</label>
        <input type="text" id="modalNombreCliente" placeholder="Ej: Gadier Sistemas">
      </div>

      <!-- Correo -->
      <div class="form-group">
        <label for="modalCorreoCliente">Correo</label>
        <input type="email" id="modalCorreoCliente" placeholder="cliente@correo.com">
      </div>

      <!-- Tel√©fono -->
      <div class="form-group">
        <label for="modalTelefonoCliente">Tel√©fono</label>
        <input type="text" id="modalTelefonoCliente" placeholder="320 555 8296">
      </div>

      <!-- Destinatario -->
      <div class="form-group">
        <label for="modalDestinatario">Dirigido a</label>
        <input type="text" id="modalDestinatario" placeholder="Ej: Oficina de Archivo ‚Äì Alcald√≠a">
      </div>

      <!-- Identificaci√≥n -->
      <div class="form-group" style="margin-top:15px;">
        <label style="font-weight:600;">Identificaci√≥n</label>

        <div style="display:flex;align-items:center;gap:10px;margin-top:6px;">
          <label style="display:flex;align-items:center;gap:4px;">
            <input type="radio" name="tipoIdent" id="identRUNT" value="RUNT">
            RUNT
          </label>

          <label style="display:flex;align-items:center;gap:4px;">
            <input type="radio" name="tipoIdent" id="identCC" value="Documento">
            Documento de identidad
          </label>
        </div>

        <input type="text" id="modalNumeroIdent" placeholder="N√∫mero" style="margin-top:8px;display:none;">
      </div>

      <!-- Botones -->
      <div class="modal-botones" style="margin-top:20px;">
        <button id="btnModalCancelar" class="btn-cancelar">Cancelar</button>

        <!-- El bot√≥n cambia seg√∫n si es PDF o PPT -->
        <button id="btnModalContinuar" class="btn-guardar" style="background:#990f0c;color:white;">
          Continuar
        </button>
      </div>
    </div>
  </div>


  <!-- ============================================================
       üß© SCRIPTS PRINCIPALES DE M√ìDULOS
  ============================================================ -->
  <script src="./assets/js/plantillasProcesos.js"></script>
  <script src="./assets/js/procesos_data.js"></script>
  <script src="./assets/js/tabla_resumen.js"></script>
  <script src="./assets/js/modulos_extras.js"></script>
  <script src="./assets/js/propuesta_valor.js"></script>
  <script src="./assets/js/pdf_gadier.js"></script>
  <script src="./assets/js/cotizacion.js"></script>


  <!-- ============================================================
       üì¶ CARGA AS√çNCRONA DEL SIDEBAR
  ============================================================ -->
  <script>
    async function loadSidebar() {
      try {
        const container = document.getElementById("sidebar");
        const res = await fetch("./includes/sidebar.html");
        const html = await res.text();

        container.innerHTML = html;

        // ================================
        // üî• ACTIVAR BOT√ìN LOGOUT CON MODAL
        // ================================
        const btnLogout = container.querySelector(".logout-btn");

        if (btnLogout) {
          btnLogout.addEventListener("click", () => {
            document.getElementById("modalLogout").style.display = "flex";
          });
        }

        // Bot√≥n cancelar
        document.getElementById("btnLogoutCancelar").addEventListener("click", () => {
          document.getElementById("modalLogout").style.display = "none";
        });

        // Bot√≥n confirmar cierre
        document.getElementById("btnLogoutConfirmar").addEventListener("click", () => {
          localStorage.removeItem("usuario_logueado");
          window.location.href = "login.html";
        });

        const s = document.createElement("script");
        s.src = "./assets/js/sidebar.js";
        s.onload = () => { if (window.initSidebar) window.initSidebar(); };
        document.body.appendChild(s);

        const current = window.location.pathname.split("/").pop();
        document.querySelectorAll(".sidebar-link").forEach(a => {
          a.classList.toggle("active", a.getAttribute("href") === current);
        });
      } catch (e) {
        console.error("Error cargando sidebar:", e);
      }
    }
    window.addEventListener("load", loadSidebar);

  </script>

  <script src="./assets/js/auth.js"></script>
  </div>

  <div id="modalColumnas" class="modal-cliente-overlay" style="display:none;">
    <div class="modal-cliente-contenedor" style="max-width:380px;">
      <h2 style="color:#990f0c;">‚öôÔ∏è Columnas visibles</h2>

      <label><input type="checkbox" class="col-toggle" data-col="0" checked> Proceso</label>
      <label><input type="checkbox" class="col-toggle" data-col="1" checked> Unidad</label>
      <label><input type="checkbox" class="col-toggle" data-col="2" checked> Cantidad</label>
      <label><input type="checkbox" class="col-toggle" data-col="3" checked> Valor Unitario</label>
      <label><input type="checkbox" class="col-toggle" data-col="4" checked> Costo Estimado</label>
      <label><input type="checkbox" class="col-toggle" data-col="5" checked> Tiempo</label>
      <label><input type="checkbox" class="col-toggle" data-col="6" checked> Acci√≥n</label>


      <div class="modal-botones" style="margin-top:20px;">
        <button id="btnCerrarColumnas" class="btn-modal-close">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btnColumnas = document.getElementById("btnColumnas");
      const modalColumnas = document.getElementById("modalColumnas");
      const btnCerrarColumnas = document.getElementById("btnCerrarColumnas");

      // Abrir modal
      btnColumnas.addEventListener("click", () => {
        modalColumnas.style.display = "flex";
      });

      // Cerrar modal
      btnCerrarColumnas.addEventListener("click", () => {
        modalColumnas.style.display = "none";
      });

      // Cerrar al hacer clic afuera
      modalColumnas.addEventListener("click", (e) => {
        if (e.target === modalColumnas) {
          modalColumnas.style.display = "none";
        }
      });
    });
  </script>

  <!-- ============================================================
     üî¥ MODAL CONFIRMACI√ìN DE CIERRE DE SESI√ìN
  =============================================================== -->
  <div id="modalLogout" class="modal-cliente-overlay" style="display:none;">
    <div class="modal-cliente-contenedor" style="max-width:360px;text-align:center;">

      <h2 style="color:#990f0c;margin-bottom:10px;">‚èª Cerrar sesi√≥n</h2>
      <p style="font-size:15px;line-height:1.4;color:#333;">
        ¬øSeguro que deseas cerrar tu sesi√≥n en Gadier Sistemas?
      </p>

      <div class="modal-botones" style="margin-top:20px;">
        <button id="btnLogoutCancelar" class="btn-cancelar">Cancelar</button>
        <button id="btnLogoutConfirmar" class="btn-guardar" style="background:#990f0c;color:white;">
          S√≠, cerrar sesi√≥n
        </button>
      </div>
    </div>
  </div>

  <script>
    // Guarda el modo actual ("PDF" o "PPT")
    let modoActual = "";

    // Abrir modal universal
    function abrirModalDatosCliente(modo) {
      document.getElementById("guardarFavorito").checked = false;
      modoActual = modo;

      const modal = document.getElementById("modalDatosCliente");
      modal.style.display = "flex";

      const selectFav = document.getElementById("clienteExistenteSelect");
      const favoritos = window.obtenerFavoritos();

      // Llenar select
      selectFav.innerHTML = `<option value="">‚Äî Cliente nuevo ‚Äî</option>`;
      favoritos.forEach((f, idx) => {
        selectFav.innerHTML += `<option value="${idx}">${f.nombre}</option>`;
      });

      // Cuando seleccionan un favorito ‚Üí autocompletar
      selectFav.onchange = () => {
        const idx = selectFav.value;
        if (idx === "") {
          modalNombreCliente.value = "";
          modalCorreoCliente.value = "";
          modalTelefonoCliente.value = "";
          modalDestinatario.value = "";
          modalNumeroIdent.value = "";
          return;
        }

        const fav = favoritos[idx];

        modalNombreCliente.value = fav.nombre || "";
        modalCorreoCliente.value = fav.correo || "";
        modalTelefonoCliente.value = fav.telefono || "";
        modalDestinatario.value = fav.destinatario || "";
        modalNumeroIdent.value = fav.numeroIdent || "";

        if (fav.tipoIdent === "RUNT") identRUNT.checked = true;
        else if (fav.tipoIdent === "Documento") identCC.checked = true;
      };
    }




    // Mostrar input n√∫mero cuando eligen tipo de documento
    document.addEventListener("change", (e) => {
      if (e.target.id === "identRUNT" || e.target.id === "identCC") {
        document.getElementById("modalNumeroIdent").style.display = "block";
      }
    });

    // Bot√≥n cancelar
    document.getElementById("btnModalCancelar").onclick = () => {
      document.getElementById("modalDatosCliente").style.display = "none";
    };

    // Bot√≥n continuar
    document.getElementById("btnModalContinuar").onclick = () => {

      const nombre = document.getElementById("modalNombreCliente").value.trim();
      const correo = document.getElementById("modalCorreoCliente").value.trim();
      const telefono = document.getElementById("modalTelefonoCliente").value.trim();
      const destinatario = document.getElementById("modalDestinatario").value.trim();

      const tipoIdent = document.querySelector('input[name="tipoIdent"]:checked')?.value || "";
      const numeroIdent = document.getElementById("modalNumeroIdent").value.trim();

      if (!nombre) return alert("Ingrese el nombre del cliente.");
      if (!correo) return alert("Ingrese el correo.");

      // Guardar datos globales
      window.datosClienteGlobal = {
        nombre,
        correo,
        telefono,
        destinatario,
        tipoIdent,
        numeroIdent
      };

      // ‚≠ê Guardar como favorito SOLO si el usuario lo marc√≥
      const esFavorito = document.getElementById("guardarFavorito").checked;
      if (esFavorito) {
        window.guardarFavorito(window.datosClienteGlobal);
      }

      document.getElementById("modalDatosCliente").style.display = "none";

      // Llamar flujo seg√∫n modo
      if (modoActual === "PDF") generarPDFConDatos();
      if (modoActual === "PPT") generarPPTConDatos();
    };
  </script>


</body>

</html>